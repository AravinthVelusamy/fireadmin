'use strict';(function(g,p,n){function d(a,b){if("undefined"==typeof a||"string"!=typeof a)throw Error("Url is required to use FireAdmin");this.ref=new Firebase(a);this.fbUrl=a;this.appName=a.replace("https://","").replace(".firebaseio.com","");return this}function l(a,b,e,f){a="http://localhost:8080/"+a;console.log("apiRequest sending to "+a+" ...");n.net.XhrIo.send(a,function(a){a.target.isComplete()&&a.target.isSuccess()?(a=a.target.getResponse(),console.log("apiRequest responded:",a),a?c(e,a):
(console.error("Server error"),c(f,{code:"SERVER_ERROR"}))):c(f,a.target.getLastError())},"POST",b)}function m(a,b,e,f){console.log("createUserAccount called:",arguments);var k=b.child("users").child(a.uid),h={role:10,provider:a.provider};"password"==a.provider?h.email=a.password.email:(console.log("create 3rd party linked profile:",a),n.object.extend(h,a));b.child("users").orderByChild("email").equalTo(signupData.email).on("value",function(a){if(a.val())a={message:"This email has already been used to create an account",
account:JSON.stringify(a.val()),status:"ACCOUNT_EXISTS"},c(f,a);else k.once("value",function(a){null==a.val()||a.hasChild("sessions")?(h.createdAt=Firebase.ServerValue.TIMESTAMP,k.setWithPriority(h,h.email,function(b){b?c(f,{message:"Error creating user profile"}):(console.log("New user account created:",a.val()),c(e,a.val()))})):(console.error("User account already exists",a.val()),c(f,a.val()))})},function(a){c(f,a)})}function c(a,b){if(a&&"function"==typeof a)return b?a(b):a()}(function(){var a=
g.Firebase.SDK_VERSION.replace(".","").replace(".",""),b="2.1.2".replace(".","").replace(".","");if("undefined"==typeof g.Firebase)throw Error("Firebase is required to use FireAdmin");a<b&&console.warn("Unsupported Firebase version: "+g.Firebase.SDK_VERSION+". Please upgrade to 2.1.2 or newer.")})();g.goog.require("goog.net.XhrIo");g.goog.require("goog.object");g.Fireadmin=d;d.prototype.createObject=function(a,b,e,f){var k=this.ref.getAuth();k&&(b.author=k.uid);b.createdAt=Date.now();this.ref.child(a).push(b,
function(a){a?c(f,a):c(e,b)})};d.prototype.listByCurrentUser=function(a,b,e){var f=this.ref.getAuth();if(null!=f)this.child(a).orderByChild("author").equalTo(f.uid).on("value",function(a){c(b,a.val())},function(a){c(e,a)});else a={code:"INVALID_AUTH",message:"listByCurrentUser cannot load list without current user"},console.error(a.message),c(e,a)};d.prototype.listByUid=function(a,b,e,f){this.fbRef(a).orderByChild("author").equalTo(b).on("value",function(a){c(e,a.val())},function(a){c(f,a)})};d.prototype.getObjectCount=
function(a,b,e){this.fbRef(a).on("value",function(a){c(b,a.numChildren())},function(a){c(e,a)})};d.prototype.getUserCount=function(a,b){this.ref.child("users").on("value",function(b){c(a,b.numChildren())},function(a){c(b,a)})};d.prototype.getOnlineUserCount=function(a,b){this.ref.child("presence").on("value",function(b){console.log("There are currently"+count+" users online.");c(a,b.numChildren())},function(a){c(b,a)})};d.prototype.sessionsBetween=function(a,b,e,f){console.log("start:"+a+" end "+
b);this.ref.child("sessions").orderByChild("ended").startAt(a).endAt(b).on("value",function(a){c(e,a.numChildren())},function(a){c(f,a)})};d.prototype.sessionsSince=function(a,b,e){this.ref.child("sessions").orderByChild("ended").startAt(a).endAt(Date.now()).on("value",function(a){c(b,a.numChildren())},function(a){c(e,a)})};d.prototype.averageSessionLength=function(a,b){this.ref.child("sessions").on("value",function(b){var f=null,d=b.numChildren();b.forEach(function(a){var b=a.val();b.hasOwnProperty("ended")&&
b.hasOwnProperty("began")?(f+=(b.ended-b.began)/6E4,console.log("total length is now:",f)):(console.log("removing unfinished session:",a.val()),d--,console.log("session count:",d))});console.log("totalLength:",f);b=Math.floor(f/d);console.log("average in minutes:",b);c(a,b)},function(a){c(b,a)})};d.prototype.removeUserSessions=function(a,b,e){this.ref.child("sessions").orderByChild("user").equalTo(a).on("value",function(a){var e=a.numChildren();a.forEach(function(a){a.ref().remove()});console.log(e+
" Sessions sucessfully removed");c(b)},function(a){c(e,a)})};d.prototype.uploadImage=function(a,b,e){l("upload",{appName:this.appName,image:a},function(a){a.hasOwnProperty("url")?(a={url:a.url},console.log("Image data object:",a),c(b,a)):c(e,{code:"SERVER_ERROR"})},function(a){c(e,a)})};d.prototype.customAuthToken=function(a,b,e){l("auth",{appName:this.appName},function(a){a.hasOwnProperty("token")?(console.log("Image data object:",imgDataObj),c(b,imgDataObj)):c(e,{code:"SERVER_ERROR"})},function(a){c(e,
a)})};d.prototype.userSignup=function(a,b,e){var f=this;if("object"==typeof a&&a.hasOwnProperty("email")){if(!a.hasOwnProperty("password")&&8>=a.password.length)return c(e,{message:"A valid Password is required to signup."});f.createUser(a,function(d){null===d?(console.log("[emailSignup] User created successfully. Logging in as new user..."),f.emailAuth(a,function(a){m(a,f.ref,function(a){c(b,a)},function(a){c(e,a)})},function(a){c(e,a)})):(console.error("[emailSignup] Error creating user:",d.message),
c(e,d))})}else if(a.hasOwnProperty("type")&&"username"==a.type)l("signup",a,function(a){console.log("request for token successful:",a);f.authWithCustomToken(a.token,function(a,d){a?c(e,a):m(d,f.ref,function(a){c(b,a)},function(a){c(e,a)})})},function(a){c(e,a)});else if("string"==typeof a||a.hasOwnProperty("type")){if("string"==typeof a)var d=a;else a.hasOwnProperty("type")&&(d=a.type);f.authWithOAuthPopup(d,function(a,d){a?c(e,a):m(d,f.ref,function(a){c(b,a)},function(a){c(e,a)})})}};d.prototype.emailAuth=
function(a,b,e){var f=this.ref;f.authWithPassword(a,function(a,d){null===a?(console.log("User ID: "+d.uid+", Provider: "+d.provider),f.setupPresence(d.uid),c(b,d)):(console.error("Error authenticating user:",a),c(e,a))})};d.prototype.authWithOAuthPopup=function(a,b,e){var f=this.ref;f.authWithOAuthPopup(a,function(a,d){null===a?(console.log("User ID: "+d.uid+", Provider: "+d.provider),f.setupPresence(d.uid),c(b,d)):(console.error("Error authenticating user:",a),c(e,a))})};d.prototype.newUserFromAnonyomous=
function(){};d.prototype.newUserFromAnonyomous=function(){};d.prototype.githubAuth=function(a,b){return this.authWithOAuthPopup("github",a,b)};d.prototype.googleAuth=function(a,b){return this.authWithOAuthPopup("google",a,b)};d.prototype.twitterAuth=function(a,b){return this.authWithOAuthPopup("twitter",a,b)};d.prototype.accountByUid=function(a,b,d){this.ref.child(a).on("value",function(a){c(b,a.val())},function(b){console.error("Error getting account for "+a+" : ",b);c(d,b)})};d.prototype.accountByEmail=
function(a,b,d){if(a&&"string"==typeof a)this.ref.child("users").orderByChild("email").equalTo(a).on("value",function(a){console.log("accountByEmail returned:",a.val());c(b,a.val())},function(a){console.error("Error getting account by email:",a);c(d,a)});else c(d)};d.prototype.setupPresence=function(a){console.log("setupPresence called for uid:",a);var b=this.ref,c=b.child(".info/connected"),d=b.child("presence").child(a),k=b.child("sessions");b.child("users").child(a);var h=b.child("users").child(a).child("sessions");
h.child("past");c.on("value",function(c){if(c.val()){b.onDisconnect();c=k.push({began:Firebase.ServerValue.TIMESTAMP,user:a});var e=c.child("ended");e.onDisconnect().set(Firebase.ServerValue.TIMESTAMP);var g=h.child("current").push(c.key());g.onDisconnect().remove();d.set(!0);d.onDisconnect().remove();b.onAuth(function(a){a||(e.set(Firebase.ServerValue.TIMESTAMP),g.remove(),d.remove())})}})};d.prototype.fbRef=function(a){var b=this.ref,c=Array.prototype.slice.call(arguments);c.length&&(b=b.child(pathRef(c)));
return b}})(window,document,goog);

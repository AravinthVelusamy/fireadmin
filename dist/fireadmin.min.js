function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}();!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("firebase"),require("lodash")):"function"==typeof define&&define.amd?define(["firebase","lodash"],r):e.Fireadmin=r(e.Firebase,e._)}(this,function(e,r){"use strict";function n(e,r){return e&&console[e]?console[e].apply(console,r):console.log.apply(console,r)}function t(e){var n="",t={};r.isObject(e)?("debug"==a&&r.has(e,"func")&&(n+=r.has(e,"obj")?"["+e.obj+"."+e.func+"()]\n ":r.has(e,"file")?"["+e.file+" > "+e.func+"()]\n ":"["+e.func+"()]\n "),r.each(r.omit(r.keys(e)),function(i,o,u){"func"!=i&&"obj"!=i&&("description"==i||"message"==i?n+=e[i]:r.isString(e[i])?t[i]=e[i]:t[i]=e[i])}),n+="\n"):r.isString(e)&&(n=e);var i=[n,t];return i}function i(e){return e.match(/^(?:https?|ftp)?:\/\/([A-Za-z0-9\-]{0,61}[A-Za-z0-9])?/)[1]}function o(e,r,n,t){console.log("apiRequest sending to "+reqUrl+" ...")}function u(n,t){console.log("createUserAccount called:",arguments);var i=t.child("users").child(n.uid),o={role:10,provider:n.provider};return"password"==n.provider?o.email=n.password.email:(console.log("create 3rd party linked profile:",n),r.extend(o,n)),t.child("users").orderByChild("email").equalTo(o.email).on("value",function(r){if(r.val()){var n={message:"This email has already been used to create an account",account:JSON.stringify(r.val()),status:"ACCOUNT_EXISTS"};return Promise.reject(n)}i.once("value",function(r){return null==r.val()||r.hasChild("sessions")?(o.createdAt=e.ServerValue.TIMESTAMP,i.setWithPriority(o,o.email,function(e){return e?Promise.reject({message:"Error creating user profile"}):(console.log("New user account created:",r.val()),Promise.resolve(r.val()))})):(console.error("User account already exists",r.val()),Promise.reject(r.val()))})},function(e){return Promise.reject(e)})}e="default"in e?e["default"]:e,r="default"in r?r["default"]:r;var s={},a="debug";s.logLevel&&(a=s.logLevel);var c={log:function(e){var r=t(e);"production"==s.envName?n("log",r):n("log",r)},info:function(e){var r=t(e);"production"==s.envName?n("info",r):n("info",r)},warn:function(e){var r=t(e);"production"==s.envName?n("warn",r):n("warn",r)},debug:function(e){var r=t(e);"production"==s.envName||n("debug",r)},error:function(e){var r=t(e);"production"==s.envName?n("error",r):n("error",r)}},l=function(){function r(n,t){if(_classCallCheck(this,r),!n)throw c.error({description:"Application name requires to use Fireadmin.",func:"constructor",obj:"Fireadmin"}),new Error("Application name is required to use Fireadmin");this.ref=new e(n),this.fbUrl=n,this.appName=i(n),t&&(this.options=t)}return _createClass(r,[{key:"createObject",value:function(e,r){var n=this,t=this.ref.getAuth();return t&&(r.author=t.uid),r.createdAt=Date.now(),new Promise(function(t,i){n.ref.child(e).push(r,function(e){return e?i(e):t(r)})})}},{key:"listByCurrentUser",value:function(e){var r=this;if(!e)return Promise.reject({message:"Listname required to list objects."});if(this.isAuthorized)return new Promise(function(n,t){var i=r.ref.child(e).orderByChild("author").equalTo(auth.uid);i.on("value",function(e){return n(e.val())},function(e){return t(e)})});var n={code:"INVALID_AUTH",message:"listByCurrentUser cannot load list without current user"};return c.error(n.message),Promise.reject(n)}},{key:"listByUid",value:function(e,r){var n=this;return new Promise(function(t,i){n.fbRef(e).orderByChild("author").equalTo(r).on("value",function(e){return Promise.resolve(e.val())},function(e){return Promise.reject(e)})})}},{key:"getUserCount",value:function(){var e=this;return new Promise(function(r,n){e.ref.child("users").on("value",function(e){r(e.numChildren())},function(e){c.error({description:"Error getting user count.",func:"getUserCount",obj:"Fireadmin"}),n(e)})})}},{key:"getOnlineUserCount",value:function(){var e=this;return new Promise(function(r,n){e.ref.child("presence").on("value",function(e){c.log("There are currently"+e.numChildren()+" users online."),r(e.numChildren())},function(e){n(e)})})}},{key:"sessionsBetween",value:function(e,r){var n=this;return c.log({description:"Sessions between called.",startTime:e,endTime:r,func:"sessionsBetween",obj:"Fireadmin"}),new Promise(function(t,i){n.ref.child("sessions").orderByChild("ended").startAt(e).endAt(r).on("value",function(e){t(e.numChildren())},function(e){c.error({description:"Error getting sessions between specified times.",error:e,func:"sessionsBetween",obj:"Fireadmin"}),i({message:"Error getting sessions."})})})}},{key:"sessionsSince",value:function(e){var r=this;return new Promise(function(n,t){r.ref.child("sessions").orderByChild("ended").startAt(e).endAt(Date.now()).on("value",function(e){return n(e.numChildren())},function(e){return c.error({description:"Error getting sessions between specified times.",error:e,func:"sessionsSince",obj:"Fireadmin"}),t(e)})})}},{key:"averageSessionLength",value:function(){var e=this;return new Promise(function(r,n){e.ref.child("sessions").on("value",function(e){var n=null,t=e.numChildren();e.forEach(function(e){var r=e.val();if(r.hasOwnProperty("ended")&&r.hasOwnProperty("began")){var i=(r.ended-r.began)/6e4;n+=i,c.log("total length is now:",n)}else c.log("removing unfinished session:",e.val()),t--,c.log("session count:",t)}),c.log("totalLength:",n);var i=Math.floor(n/t);return c.log("average in minutes:",i),r(i)},function(e){return n(e)})})}},{key:"removeUserSessions",value:function(e){var r=this;return new Promise(function(n,t){r.ref.child("sessions").orderByChild("user").equalTo(e).on("value",function(e){var r=e.numChildren();return e.forEach(function(e){e.ref().remove()}),c.log(r+" Sessions sucessfully removed"),n()},function(e){return t(e)})})}},{key:"customAuthToken",value:function(e){var r=this,n={appName:r.appName};o("auth",n,function(e){return e.hasOwnProperty("token")?(c.log("auth request response:",e),Promise.resolve(e)):Promise.reject({code:"SERVER_ERROR"})},function(e){return Promise.reject(e)})}},{key:"userSignup",value:function(e){var r=this;if("object"==typeof e&&e.hasOwnProperty("email"))return!e.hasOwnProperty("password")&&e.password.length<=8?handleCb(errorCb,{message:"A valid Password is required to signup."}):new Promise(function(n,t){r.createUser(e,function(i){null===i?(c.log("[emailSignup] User created successfully. Logging in as new user..."),r.emailAuth(e,function(e){u(e,r.ref,function(e){n(e)},function(e){t(e)})},function(e){t(e)})):(c.error("[emailSignup] Error creating user:",i.message),t(i))})});if(e.hasOwnProperty("type")&&"username"==e.type)o("signup",e,function(e){return c.log("request for token successful:",e),r.authWithCustomToken(e.token,function(e,n){return e?Promise.reject(e):u(n,r.ref,function(e){return Promise.resolve(e)},function(e){return Promise.reject(e)})})},function(e){return Promise.reject(e)});else if("string"==typeof e||e.hasOwnProperty("type")){var n="string"==typeof e?e:e.type;return this.authWithOAuthPopup(n,function(e,n){return e?Promise.reject(e):u(n,r.ref,function(e){return Promise.resolve(e)},function(e){return Promise.reject(e)})})}}},{key:"emailAuth",value:function(e){var r=this;return new Promise(function(n,t){r.ref.authWithPassword(e,function(e,i){return null===e?(c.log({description:"Successfully authed.",authData:i,userId:i.uid,provider:i.provider,func:"emailAuth",obj:"Fireadmin"}),r.setupPresence(i.uid),n(i)):(c.error("Error authenticating user:",e),t(err))})})}},{key:"authWithOAuthPopup",value:function(e){var r=this;return new Promise(function(n,t){r.ref.authWithOAuthPopup(e,function(e,i){return null===e?(c.log({description:"Auth popup responded.",authData:i,id:i.uid,provider:i.provider,func:"authWithOAuthPopup",obj:"Fireadmin"}),r.setupPresence(i.uid),n(i)):(c.error("Error authenticating user:",e),t(e))})})}},{key:"newUserFromAnonyomous",value:function(){}},{key:"githubAuth",value:function(){return this.authWithOAuthPopup("github")}},{key:"googleAuth",value:function(){return this.authWithOAuthPopup("google")}},{key:"twitterAuth",value:function(){return this.authWithOAuthPopup("twitter")}},{key:"accountByUid",value:function(e){var r=this;return new Promise(function(n,t){r.ref.child(e).on("value",function(e){n(e.val())},function(r){c.error({description:"Error getting account by UID.",uid:e,error:r,func:"accountByUid",obj:"Fireadmin"}),t(r)})})}},{key:"accountByEmail",value:function(e){return e&&"string"==typeof e?this.ref.child("users").orderByChild("email").equalTo(e).on("value",function(e){return c.log("accountByEmail returned:",e.val()),Promise.resolve(e.val())},function(e){return c.error("Error getting account by email:",e),Promise.reject(e)}):Promise.reject({message:"Email is required to get account."})}},{key:"setupPresence",value:function(r){var n=this;c.log({description:"setupPresence called",uid:r,func:"setupPresense",obj:"Fireadmin"});var t=this.ref.child(".info/connected"),i=this.ref.child("presence").child(r),o=this.ref.child("sessions"),u=(this.ref.child("users").child(r),this.ref.child("users").child(r).child("sessions"));u.child("past");return t.on("value",function(t){if(t.val()){var s=(n.ref.onDisconnect(),o.push({began:e.ServerValue.TIMESTAMP,user:r})),a=s.child("ended");a.onDisconnect().set(e.ServerValue.TIMESTAMP);var c=u.child("current").push(s.key());c.onDisconnect().remove(),i.set(!0),i.onDisconnect().remove(),n.onAuth(function(r){r||(a.set(e.ServerValue.TIMESTAMP),c.remove(),i.remove())})}})}},{key:"fbRef",value:function(e){var r=this.ref,n=Array.prototype.slice.call(arguments);return n.length&&(r=r.child(pathRef(n))),r}},{key:"auth",get:function(){return this.ref.getAuth()}},{key:"isAuthorized",get:function(){return!this.auth||null===this.auth}}]),r}();return l});
//# sourceMappingURL=fireadmin.min.js.map

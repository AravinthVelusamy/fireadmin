function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}();!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("lodash")):"function"==typeof define&&define.amd?define(["lodash"],r):e.Fireadmin=r(e._)}(this,function(e){"use strict";function r(e,r){return e&&console[e]?console[e].apply(console,r):console.log.apply(console,r)}function n(r){var n="",t={};e.isObject(r)?("debug"==i&&e.has(r,"func")&&(n+=e.has(r,"obj")?"["+r.obj+"."+r.func+"()]\n ":e.has(r,"file")?"["+r.file+" > "+r.func+"()]\n ":"["+r.func+"()]\n "),e.each(e.omit(e.keys(r)),function(i,o,s){"func"!=i&&"obj"!=i&&("description"==i||"message"==i?n+=r[i]:e.isString(r[i])?t[i]=r[i]:t[i]=r[i])}),n+="\n"):e.isString(r)&&(n=r);var o=[n,t];return o}e="default"in e?e["default"]:e;var t={},i="debug";t.logLevel&&(i=t.logLevel);var o={log:function(e){var i=n(e);"production"==t.envName?r("log",i):r("log",i)},info:function(e){var i=n(e);"production"==t.envName?r("info",i):r("info",i)},warn:function(e){var i=n(e);"production"==t.envName?r("warn",i):r("warn",i)},debug:function(e){var i=n(e);"production"==t.envName||r("debug",i)},error:function(e){var i=n(e);"production"==t.envName?r("error",i):r("error",i)}},s=function(){function e(r,n){if(_classCallCheck(this,e),!r)throw o.error({description:"Application name requires to use Fireadmin.",func:"constructor",obj:"Fireadmin"}),new Error("Application name is required to use Fireadmin");this.ref=new Firebase(r),this.fbUrl=r,this.appName=AppNameFromUrl(r),n&&(this.options=n)}return _createClass(e,[{key:"createObject",value:function(e,r){var n=this.ref.getAuth();return n&&(r.author=n.uid),r.createdAt=Date.now(),this.ref.child(e).push(r,function(e){return e?Promise.reject(e):Promise.resolve(r)})}},{key:"listByCurrentUser",value:function(e){if(!e)return Promise.reject({message:"Listname required to list objects."});if(this.isAuthorized){var r=this.ref.child(e).orderByChild("author").equalTo(auth.uid);return r.on("value",function(e){return Promise.resolve(e.val())},function(e){return Promise.reject(e)})}var n={code:"INVALID_AUTH",message:"listByCurrentUser cannot load list without current user"};return o.error(n.message),Promise.reject(n)}},{key:"listByUid",value:function(e){return this.fbRef(listPath).orderByChild("author").equalTo(e).on("value",function(e){return Promise.resolve(e.val())},function(e){return Promise.reject(e)})}},{key:"getUserCount",value:function(){return this.ref.child("users").on("value",function(e){return Promise.resolve(e.numChildren())},function(e){return o.error({description:"Error getting user count.",func:"getUserCount",obj:"Fireadmin"}),Promise.reject(e)})}},{key:"getOnlineUserCount",value:function(){return this.ref.child("presence").on("value",function(e){return o.log("There are currently"+e.numChildren()+" users online."),Promise.resolve(e.numChildren())},function(e){return Promise.reject(e)})}},{key:"sessionsBetween",value:function(e,r){return o.log({description:"Sessions between called.",startTime:e,endTime:r,func:"sessionsBetween",obj:"Fireadmin"}),this.ref.child("sessions").orderByChild("ended").startAt(e).endAt(r).on("value",function(e){return Promise.resolve(e.numChildren())},function(e){return o.error({description:"Error getting sessions between specified times.",error:e,func:"sessionsBetween",obj:"Fireadmin"}),Promise.reject({message:"Error getting sessions."})})}},{key:"sessionsSince",value:function(e){return this.ref.child("sessions").orderByChild("ended").startAt(e).endAt(Date.now()).on("value",function(e){return Promise.resolve(e.numChildren())},function(e){return o.error({description:"Error getting sessions between specified times.",error:e,func:"sessionsSince",obj:"Fireadmin"}),Promise.reject(e)})}},{key:"averageSessionLength",value:function(){return this.ref.child("sessions").on("value",function(e){var r=null,n=e.numChildren();e.forEach(function(e){var t=e.val();if(t.hasOwnProperty("ended")&&t.hasOwnProperty("began")){var i=(t.ended-t.began)/6e4;r+=i,o.log("total length is now:",r)}else o.log("removing unfinished session:",e.val()),n--,o.log("session count:",n)}),o.log("totalLength:",r);var t=Math.floor(r/n);return o.log("average in minutes:",t),Promise.resolve(t)},function(e){return Promise.reject(e)})}},{key:"removeUserSessions",value:function(e){return this.ref.child("sessions").orderByChild("user").equalTo(e).on("value",function(e){var r=e.numChildren();return e.forEach(function(e){e.ref().remove()}),o.log(r+" Sessions sucessfully removed"),Promise.resolve()},function(e){return Promise.reject(e)})}},{key:"customAuthToken",value:function(e){var r=this,n={appName:r.appName};apiRequest("auth",n,function(e){return e.hasOwnProperty("token")?(o.log("auth request response:",e),Promise.resolve(e)):Promise.reject({code:"SERVER_ERROR"})},function(e){return Promise.reject(e)})}},{key:"userSignup",value:function(e){var r=this;if("object"==typeof e&&e.hasOwnProperty("email"))return!e.hasOwnProperty("password")&&e.password.length<=8?handleCb(errorCb,{message:"A valid Password is required to signup."}):this.createUser(e,function(n){return null!==n?(o.error("[emailSignup] Error creating user:",n.message),Promise.reject(n)):(o.log("[emailSignup] User created successfully. Logging in as new user..."),void r.emailAuth(e,function(e){return createUserProfile(e,r.ref,function(e){return Promise.resolve(e)},function(e){return Promise.reject(e)})},function(e){return Promise.reject(e)}))});if(e.hasOwnProperty("type")&&"username"==e.type)apiRequest("signup",e,function(e){return o.log("request for token successful:",e),r.authWithCustomToken(e.token,function(e,n){return e?Promise.reject(e):createUserProfile(n,r.ref,function(e){return Promise.resolve(e)},function(e){return Promise.reject(e)})})},function(e){return Promise.reject(e)});else if("string"==typeof e||e.hasOwnProperty("type")){var n="string"==typeof e?e:e.type;return this.authWithOAuthPopup(n,function(e,n){return e?Promise.reject(e):createUserProfile(n,r.ref,function(e){return Promise.resolve(e)},function(e){return Promise.reject(e)})})}}},{key:"emailAuth",value:function(e){var r=this;return this.ref.authWithPassword(e,function(e,n){return null===e?(o.log("User ID: "+n.uid+", Provider: "+n.provider),r.setupPresence(n.uid),Promise.resolve(n)):(o.error("Error authenticating user:",e),Promise.reject(err))})}},{key:"authWithOAuthPopup",value:function(e){var r=this;return this.ref.authWithOAuthPopup(e,function(e,n){return null===e?(o.log({description:"Auth popup responded.",authData:n,id:n.uid,provider:n.provider,func:"authWithOAuthPopup",obj:"Fireadmin"}),r.setupPresence(n.uid),Promise.resolve(n)):(o.error("Error authenticating user:",e),Promise.reject(e))})}},{key:"newUserFromAnonyomous",value:function(){}},{key:"githubAuth",value:function(){return this.authWithOAuthPopup("github")}},{key:"googleAuth",value:function(){return this.authWithOAuthPopup("google")}},{key:"twitterAuth",value:function(){return this.authWithOAuthPopup("twitter")}},{key:"accountByUid",value:function(e){return this.ref.child(e).on("value",function(e){handleCb(successCb,e.val())},function(r){return o.error("Error getting account for "+e+" : ",r),Promise.reject(r)})}},{key:"accountByEmail",value:function(e){return e&&"string"==typeof e?this.ref.child("users").orderByChild("email").equalTo(e).on("value",function(e){return o.log("accountByEmail returned:",e.val()),Promise.resolve(e.val())},function(e){return o.error("Error getting account by email:",e),Promise.reject(e)}):Promise.reject({message:"Email is required to get account."})}},{key:"setupPresence",value:function(e){var r=this;o.log({description:"setupPresence called",uid:e,func:"setupPresense",obj:"Fireadmin"});var n=this.ref.child(".info/connected"),t=this.ref.child("presence").child(e),i=this.ref.child("sessions"),s=(this.ref.child("users").child(e),this.ref.child("users").child(e).child("sessions"));s.child("past");return n.on("value",function(n){if(n.val()){var o=(r.ref.onDisconnect(),i.push({began:Firebase.ServerValue.TIMESTAMP,user:e})),u=o.child("ended");u.onDisconnect().set(Firebase.ServerValue.TIMESTAMP);var c=s.child("current").push(o.key());c.onDisconnect().remove(),t.set(!0),t.onDisconnect().remove(),r.onAuth(function(e){e||(u.set(Firebase.ServerValue.TIMESTAMP),c.remove(),t.remove())})}})}},{key:"fbRef",value:function(e){var r=this.ref,n=Array.prototype.slice.call(arguments);return n.length&&(r=r.child(pathRef(n))),r}},{key:"auth",get:function(){return this.ref.getAuth()}},{key:"isAuthorized",get:function(){return!this.auth||null===this.auth}}]),e}();return s});
//# sourceMappingURL=fireadmin.min.js.map
